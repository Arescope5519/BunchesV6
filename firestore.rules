rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Helper function to check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }

    // Helper function to check if user owns the document
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }

    // Users collection - profile data
    match /users/{userId} {
      // Anyone authenticated can read any user profile (for social features)
      allow read: if isAuthenticated();
      // User can only write their own profile
      allow write: if isOwner(userId);

      // Recipes subcollection
      match /recipes/{recipeId} {
        // User can read/write their own recipes
        allow read, write: if isOwner(userId);
      }
    }

    // Usernames collection - for username lookup/availability
    match /usernames/{username} {
      // Anyone authenticated can read usernames (for search/validation)
      allow read: if isAuthenticated();
      // Only allow creating new username entries (handled by server-side logic)
      allow create: if isAuthenticated();
      // No updates or deletes allowed directly
      allow update, delete: if false;
    }

    // Friend requests collection
    match /friend_requests/{requestId} {
      // Allow reading individual documents where user is sender or recipient
      allow get: if isAuthenticated() &&
        (resource.data.from == request.auth.uid || resource.data.to == request.auth.uid);
      // Allow listing/querying all friend requests (queries will be filtered by app)
      allow list: if isAuthenticated();
      // User can create requests where they are the sender
      allow create: if isAuthenticated() && request.resource.data.from == request.auth.uid;
      // User can update/delete requests where they are sender or recipient
      allow update, delete: if isAuthenticated() &&
        (resource.data.from == request.auth.uid || resource.data.to == request.auth.uid);
    }

    // Shared items collection
    match /shared_items/{itemId} {
      // Allow reading individual documents where user is recipient
      allow get: if isAuthenticated() && resource.data.toUserId == request.auth.uid;
      // Allow listing/querying all shared items (queries will be filtered by app)
      allow list: if isAuthenticated();
      // User can create items where they are the sender
      allow create: if isAuthenticated() && request.resource.data.fromUserId == request.auth.uid;
      // User can update/delete items where they are sender or recipient
      allow update, delete: if isAuthenticated() &&
        (resource.data.fromUserId == request.auth.uid || resource.data.toUserId == request.auth.uid);
    }

    // Deny all other access by default
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
